#!/bin/bash
# Drumee loader
if [ "$USER" != "root" ]; then
  echo This installation script must be run with root privilege
  echo Once done, go to $PWD and run this script again
  exit 1
fi
script_dir=$(dirname $(readlink -f $0))
base_dir=$(dirname $script_dir)
source $script_dir/functions

ports_check=yes
reinstall=
repository=
for arg in "$@"; do
  case $arg in
  --skip-ports-check=*)
    ports_check="no"
    shift
    ;;
  --repository=*)
    repository="${arg#*=}"
    shift
    ;;
  --force-infra-install=*)
    reinstall="reinstall"
    shift
    ;;
  esac
done
set +e
install_dependencies
check_ports
install_node_packages

debconf-set-selections $base_dir/preset/postfix
install_postfix

debconf-set-selections $base_dir/preset/jitsi
install_jitsi

install_mariadb
install_drumee_packages $repository $reinstall

cd $script_dir

if [ -f /run/prosody/prosody.pid ]; then
  prosody=$(cat /run/prosody/prosody.pid)
  if [ "$prosody" != "" ]; then
    kill -9 $prosody
  fi
fi

if [ "$OWN_SSL" = "" ]; then
  # In case first init failed. Retry once
  if [ ! -f ${ACME_CERTS_DIR}/${DRUMEE_DOMAIN_NAME}_ecc/${DRUMEE_DOMAIN_NAME}.key ]; then
    /var/lib/drumee/setup-infra/bin/init-acme
  fi
fi


service prosody restart
service jicofo restart
service jitsi-videobridge2 restart
service coturn restart
service named restart
service postfix start

if [ -x /usr/sbin/drumee ]; then
  service redis-server start
  service mariadb start
  service drumee start main
  sleep 5
  service drumee start main/service
  sleep 5
  drumee install pm2-logrotate
fi

service postfix restart
service cron reload

echo Factory will start in one hour
( sleep 3600 ; service drumee start factory ) &

nginx -t
if [ "$?" = "0" ]; then
  echo Restarting Nginx server
  service nginx restart
else
  echo Some errors were fond in Nginx Server seetings.
  echo Please, fix them and restart 
fi
echo Done !